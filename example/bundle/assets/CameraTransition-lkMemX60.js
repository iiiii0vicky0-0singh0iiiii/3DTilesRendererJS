import{u as R,r as n,g as _,a as L,h as F,j as a,i as D}from"./extends-2JxA8q6w.js";import{S as A,O,k as S,j as b,aK as k,an as G}from"./three.module-CvwULque.js";import{c as q}from"./EnvironmentControls-1r8kezR_.js";import{C as B}from"./CameraTransitionManager-DRkZl6NU.js";const h=new S,v=new S,M=new S,E=new b,T=new b,P=new b,w=new G,z={};function V(c,u,o,s){T.copy(o.matrixWorld).invert(),w.origin.copy(c.position),w.direction.set(0,0,-1).transformDirection(c.matrixWorld),w.applyMatrix4(T),q(w,u,M),M.applyMatrix4(o.matrixWorld),v.set(0,0,-1).transformDirection(c.matrixWorld);const m=M.sub(c.position).dot(v);return s.copy(c.position).addScaledVector(v,m),s}function I(c){const{defaultScene:u,defaultCamera:o,overrideRenderLoop:s=!0,renderPriority:m=1}=c,i=n.useMemo(()=>new O,[]),[x,p,d,f]=R(r=>[r.set,r.size,r.gl,r.scene]);n.useEffect(()=>{x({camera:i})},[x,i]),n.useEffect(()=>{i.left=-p.width/2,i.right=p.width/2,i.top=p.height/2,i.bottom=-p.height/2,i.near=0,i.far=2e3,i.position.z=i.far/2,i.updateProjectionMatrix()},[i,p]),L(()=>{s&&d.render(u,o);const r=d.autoClear;d.autoClear=!1,d.clearDepth(),d.render(f,i),d.autoClear=r},m)}function W(){const c=n.useRef();return n.useEffect(()=>{const o=c.current.attributes.position;for(let s=0,m=o.count;s<m;s++)h.fromBufferAttribute(o,s),h.y>0&&(h.x=0,o.setXYZ(s,...h))}),a.jsx("boxGeometry",{ref:c})}function K({northColor:c=15684432,southColor:u=16777215}){const[o,s]=n.useState(),m=n.useRef();return n.useEffect(()=>{s(m.current)},[]),a.jsxs("group",{scale:.5,ref:m,children:[a.jsx("ambientLight",{intensity:1}),a.jsx("directionalLight",{position:[0,2,3],intensity:3,target:o}),a.jsx("directionalLight",{position:[0,-2,-3],intensity:3,target:o}),a.jsxs("mesh",{children:[a.jsx("sphereGeometry",{}),a.jsx("meshBasicMaterial",{color:0,opacity:.3,transparent:!0,side:k})]}),a.jsxs("group",{scale:[.5,1,.15],children:[a.jsxs("mesh",{"position-y":.5,children:[a.jsx(W,{}),a.jsx("meshStandardMaterial",{color:c})]}),a.jsxs("mesh",{"position-y":-.5,"rotation-x":Math.PI,children:[a.jsx(W,{}),a.jsx("meshStandardMaterial",{color:u})]})]})]})}function J({children:c,overrideRenderLoop:u,mode:o="3d",margin:s=10,scale:m=35,visible:i=!0,...x}){const[p,d,f]=R(e=>[e.camera,e.scene,e.size]),r=n.useContext(_),g=n.useRef(null),j=n.useMemo(()=>new A,[]);return L(()=>{if(r===null||g.current===null)return null;const{ellipsoid:e}=r,t=g.current;if(E.copy(r.group.matrixWorld).invert(),V(p,e,r.group,M).applyMatrix4(E),e.getPositionToCartographic(M,z),e.getRotationMatrixFromAzElRoll(z.lat,z.lon,0,0,0,P).premultiply(r.group.matrixWorld),P.invert(),E.copy(p.matrixWorld).premultiply(P),o.toLowerCase()==="3d")t.quaternion.setFromRotationMatrix(E).invert();else if(h.set(0,1,0).transformDirection(E).normalize(),h.z=0,h.normalize(),h.length()===0)t.quaternion.identity();else{const l=v.set(0,1,0).angleTo(h);v.cross(h).normalize(),t.quaternion.setFromAxisAngle(v,-l)}}),c||(c=a.jsx(K,{})),i?F(a.jsxs(a.Fragment,{children:[a.jsx("group",{ref:g,scale:m,position:[f.width/2-s-m/2,-f.height/2+s+m/2,0],...x,children:c}),a.jsx(I,{defaultCamera:p,defaultScene:d,overrideRenderLoop:u,renderPriority:10})]}),j,{events:{priority:10}}):null}const N=n.forwardRef(function(u,o){const{mode:s="perspective",perspectiveCamera:m,orthographicCamera:i,...x}=u,[p,d,f,r,g,j]=R(t=>[t.set,t.get,t.invalidate,t.controls,t.camera,t.size]),e=n.useMemo(()=>{const t=new B;return t.autoSync=!1,g.isOrthographicCamera?(t.orthographicCamera.copy(g),t.mode="orthographic"):t.perspectiveCamera.copy(g),t.syncCameras(),t.mode=s,t},[]);n.useEffect(()=>{const{perspectiveCamera:t,orthographicCamera:l}=e,C=j.width/j.height;t.aspect=C,t.updateProjectionMatrix(),l.left=-l.top*C,l.right=-l.left,t.updateProjectionMatrix()},[e,j]),n.useEffect(()=>{o&&(o instanceof Function?o(e):o.current=e)},[e,o]),n.useEffect(()=>{const t=({camera:l})=>{p(()=>({camera:l}))};return p(()=>({camera:e.camera})),e.addEventListener("camera-change",t),()=>{e.removeEventListener("camera-change",t)}},[e,p]),n.useEffect(()=>{const t=e.perspectiveCamera,l=e.orthographicCamera;return e.perspectiveCamera=m||t,e.orthographicCamera=i||l,p(()=>({camera:e.camera})),()=>{e.perspectiveCamera=t,e.orthographicCamera=l}},[m,i,e,p]),n.useEffect(()=>{s!==e.mode&&(r&&r.isEnvironmentControls?(r.getPivotPoint(e.fixedPoint),e.syncCameras(),r.adjustCamera(e.perspectiveCamera),r.adjustCamera(e.orthographicCamera)):(e.fixedPoint.set(0,0,-1).transformDirection(e.camera.matrixWorld).multiplyScalar(50).add(e.camera.position),e.syncCameras()),e.toggle(),f())},[s,e,f,r]),n.useEffect(()=>{const t=()=>f();return e.addEventListener("transition-start",t),e.addEventListener("change",t),e.addEventListener("transition-end",t),()=>{e.removeEventListener("transition-start",t),e.removeEventListener("change",t),e.removeEventListener("transition-end",t)}},[e,f]),D(e,x),L(()=>{e.update(),r&&(r.enabled=!e.animating);const{camera:t,size:l}=d();if(!i&&t===e.orthographicCamera){const C=l.width/l.height,y=e.orthographicCamera;C!==y.right&&(y.bottom=-1,y.top=1,y.left=-C,y.right=C,y.updateProjectionMatrix())}e.animating&&f()},-1)});export{J as C,N as a};
